#!/bin/sh -eux

# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.


if [ -z "$VERCEL_ENVIRONMENT" ]; then
  echo "Error: VERCEL_ENVIRONMENT is not set."
  exit 1
fi

if [ -z "$VERCEL_TOKEN" ]; then
  echo "Error: VERCEL_TOKEN is not set."
  exit 1
fi

echo "VERCEL_ENVIRONMENT is set to '${VERCEL_ENVIRONMENT}'"
if [ "$VERCEL_ENVIRONMENT" = "production" ]; then
  PROD_FLAG="--prod"
else
  PROD_FLAG=""
fi

npm install --global vercel@latest
vercel pull --yes --environment="$VERCEL_ENVIRONMENT" --token="$VERCEL_TOKEN" "$@"
bin/apply-vercel-csp.js --sentry-release="$SENTRY_RELEASE"
vercel build --token="$VERCEL_TOKEN" $PROD_FLAG
