#!/usr/bin/env bash

# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.


git ls-files -z | xargs -0 trufflehog --no-fail --no-update --no-verification --exclude-detectors flatio --json filesystem 2> /dev/null \
| jq -c '
  select(
    (.Raw | contains("postgres:postgres") | not)
  )' > trufflehog.log

if [ -s trufflehog.log ]; then
  jq -c -r '. | "\(.SourceMetadata.Data.Filesystem.file):\(.SourceMetadata.Data.Filesystem.line): Secret found (detector \(.DetectorName)): \(.Raw)"' trufflehog.log
fi
