#!/usr/bin/env bash

# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.

# Validates profraw files and merges them into a profdata file.
# Usage: validate-profraws.sh <output_profdata>

set -euo pipefail

output_profdata=$1

rm -rf profraws
mkdir profraws

PROFRAW_CHECK_JOBS="$(nproc 2>/dev/null)"
# shellcheck disable=SC2016
find . -name '*.profraw' -print0 | xargs -0 -n 1 -P "$PROFRAW_CHECK_JOBS" \
    sh -c 'f="$1"
        echo "$f"
        cp "$f" profraws/
        rm -f "$f"
        if ! rust-profdata merge -o /dev/null "profraws/$(basename "$f")"; then
            rm -f "profraws/$(basename "$f")"
        fi' _

find profraws -name '*.profraw' -exec rust-profdata merge -sparse -o "$output_profdata" {} +
find . -name '*.profraw' -delete
