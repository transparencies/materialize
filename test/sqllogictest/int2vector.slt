# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.

# ðŸ”¬ðŸ”¬ int2vector

query T
SELECT '1'::int2vector::text
----
1

query T
SELECT '1'::text::int2vector::text
----
1

query T
SELECT '1'::pg_catalog.int2vector::text
----
1

query T
SELECT '1 2 3'::int2vector::text
----
1 2 3

query T
SELECT '1 2 3'::int2vector::int2[]::text
----
{1,2,3}

query T
SELECT null::int2vector::text
----
NULL

query T
SELECT null::int2vector::int2[]::text
----
NULL

query error invalid input syntax for type int2vector
SELECT 'a'::int2vector::text

query error CAST does not support casting from smallint\[\] to int2vector
SELECT '{1,2,3}'::int2[]::int2vector::text

query T
SELECT ('1 2 3'::int2vector)[1]::text;
----
2

query T
SELECT ('1 2 3'::int2vector::int2[])[1]::text;
----
1

query T
SELECT ('1 2'::int2vector || '{3}'::int2[])::text;
----
{1,2,3}

query T
SELECT ('{1,2}'::int2[] || '3'::int2vector)::text;
----
{1,2,3}

query T
SELECT array_cat('1 2'::int2vector, '{3}'::int2[])::text;
----
{1,2,3}

query T
SELECT array_cat('{1,2}'::int2[], '3'::int2vector)::text;
----
{1,2,3}

query I
SELECT array_length('{1,2}'::int2[], 1);
----
2

query I
SELECT array_length('1 2'::int2vector, 1);
----
2

query T
SELECT ('{1 2 3, 4 5 6}'::int2vector[])[2]::text;
----
4 5 6

query T
SELECT ('{1 2 3, 4 5 6}'::int2vector[])[2][1]::text;
----
NULL

query T
SELECT (('{1 2 3, 4 5 6}'::int2vector[])[2])[1]::text;
----
5

query T
SELECT ARRAY (SELECT * FROM (VALUES ('1 2'::INT2VECTOR), ('3 4')))::text;
----
{"1 2","3 4"}

query TII
SELECT
	l.b::text, l.a, r.a
FROM
	(
		SELECT
			5 AS a,
			ARRAY (SELECT * FROM (VALUES ('1 2'::INT2VECTOR), ('3 4')))
				AS b
	)
		AS l
	JOIN (SELECT 6 AS a, '{1 2, 3 4}'::INT2VECTOR[] AS b) AS r ON
			l.b = r.b;
----
{"1 2","3 4"}
5
6

# Ensure that empty int2vectors are handled correctly.
# Empty int2vector formats as (empty); cast to text so we don't send int2vector (no binary encoding).
query T
SELECT ''::pg_catalog.int2vector::text
----
(empty)

# Table with int2vector column and default ''; select returns x::text to avoid binary encoding.
statement ok
CREATE TABLE t (x int2vector default '');

query T
SELECT x::text FROM t;
----

# Insert empty int2vector
statement ok
INSERT INTO t VALUES ('');

query T
SELECT x::text FROM t;
----
(empty)

# Insert single-element int2vector
statement ok
INSERT INTO t VALUES ('1');

query T
SELECT x::text FROM t ORDER BY x::text DESC;
----
1
(empty)

simple conn=mz_system,user=mz_system
ALTER SYSTEM SET enable_alter_table_add_column = true
----
COMPLETE 0

# Regression test for
# https://github.com/MaterializeInc/database-issues/issues/10087 and
# https://github.com/MaterializeInc/database-issues/issues/10088:
# this used to panic with "Can't union types: Array(Float64) and Array(Int16)"
# due to Int2Vector not being properly cast to the target array element type.

statement ok
CREATE  TABLE  t1(c0 FLOAT8[] , c1 INT2VECTOR DEFAULT '', c2 int);

query T
SELECT CASE WHEN c2 = 5 THEN c0 ELSE c1 END FROM t1;
----

query T multiline
EXPLAIN OPTIMIZED PLAN FOR
SELECT CASE WHEN c2 = 5 THEN c0 ELSE c1 END FROM t1;
----
Explained Query:
  Project (#3)
    Map (case when (#2{c2} = 5) then #0{c0} else arraytoarray(int2vectortoarray(#1{c1})) end)
      ReadStorage materialize.public.t1

Source materialize.public.t1

Target cluster: quickstart

EOF

statement ok
CREATE TABLE t0(c0 FLOAT8[], c1 INT2VECTOR DEFAULT '')

statement error WHERE clause must have type boolean, not type double precision\[\]
SELECT t0.c1 FROM t0 WHERE (CASE t0.c1 WHEN 'bZkESziLfXXL3G3YWk3j3FGvDHCwEkrTmYd9ANGvVBoF0J4Dpim3YrnbiF38bQo5HA3kxP4kz1F1V6DIgKdfsbDT' THEN t0.c0 ELSE t0.c1 END ) UNION ALL SELECT t0.c1 FROM t0 WHERE (NOT (CASE t0.c1 WHEN 'bZkESziLfXXL3G3YWk3j3FGvDHCwEkrTmYd9ANGvVBoF0J4Dpim3YrnbiF38bQo5HA3kxP4kz1F1V6DIgKdfsbDT' THEN t0.c0 ELSE t0.c1 END )) UNION ALL SELECT t0.c1 FROM t0 WHERE (((CASE t0.c1 WHEN 'bZkESziLfXXL3G3YWk3j3FGvDHCwEkrTmYd9ANGvVBoF0J4Dpim3YrnbiF38bQo5HA3kxP4kz1F1V6DIgKdfsbDT' THEN t0.c0 ELSE t0.c1 END )) IS NULL)

statement ok
CREATE  TABLE  t2(c0 INT DEFAULT '', c1 BPCHAR NOT NULL DEFAULT '');

statement ok
CREATE  TABLE  t3(c0 INT2VECTOR DEFAULT NULL, c1 INT8 LIST DEFAULT '');

statement ok
CREATE VIEW IF NOT EXISTS v0(c0) AS SELECT ARRAY[true,false,true] FROM t2, t3 HAVING (NOT NULL) LIMIT 670620142;

statement ok
ALTER TABLE t2 ADD COLUMN c2 OID;

query error NATURAL/USING join column "c0" could not convert type int2vector to boolean\[\]
SELECT t2.c2, t2.c0, v0.c0, t2.c1 FROM t2, v0 NATURAL FULL JOIN t3;
