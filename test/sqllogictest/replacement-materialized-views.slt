# Copyright Materialize, Inc. and contributors. All rights reserved.
#
# Use of this software is governed by the Business Source License
# included in the LICENSE file at the root of this repository.
#
# As of the Change Date specified in that file, in accordance with
# the Business Source License, use of this software will be governed
# by the Apache License, Version 2.0.

mode cockroach

# Reset so we get predictable catalog IDs.
reset-server

statement ok
CREATE TABLE t (a int, b int)

statement ok
CREATE MATERIALIZED VIEW mv AS SELECT a, b FROM t


# Test: usage errors

statement error cannot replace table t with materialized view rp
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR t AS SELECT a, b FROM t

statement error t is a table not a materialized view
ALTER MATERIALIZED VIEW mv APPLY REPLACEMENT t

statement error replacement would cause mv to depend on itself
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT * FROM mv

statement ok
CREATE MATERIALIZED VIEW mv2 AS SELECT * FROM mv

statement error replacement would cause mv to depend on itself
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT * FROM mv2

statement ok
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv2 AS SELECT a, b FROM t

statement error cannot replace materialized view mv with materialized view rp
ALTER MATERIALIZED VIEW mv APPLY REPLACEMENT rp

statement error cannot replace mv2 because it already has a replacement: rp
CREATE REPLACEMENT MATERIALIZED VIEW rp2 FOR mv2 AS SELECT a, b FROM t

statement ok
DROP MATERIALIZED VIEW mv2 CASCADE


# Test: replacement depends on target materialized view

statement ok
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT a, b FROM t

statement error cannot drop materialized view "mv": still depended upon by materialized view "rp"
DROP MATERIALIZED VIEW mv;


# Test: cannot create an object depending on a replacement

statement error replacement materialized view rp cannot be depended upon
CREATE VIEW v AS SELECT * FROM rp

statement error replacement materialized view rp cannot be depended upon
CREATE MATERIALIZED VIEW mv2 AS SELECT * FROM rp

statement error index cannot be created on materialize.public.rp because it is a replacement materialized view
CREATE DEFAULT INDEX ON rp


# Test: comments on replacements

statement ok
COMMENT ON MATERIALIZED VIEW rp IS 'comment:rp'

statement ok
COMMENT ON COLUMN rp.a IS 'comment:rp.a'

query TT rowsort
SELECT object_sub_id, comment
FROM mz_internal.mz_comments
WHERE object_type = 'materialized-view'
----
NULL  comment:rp
1     comment:rp.a

statement ok
ALTER MATERIALIZED VIEW mv APPLY REPLACEMENT rp

query TT rowsort
SELECT object_sub_id, comment
FROM mz_internal.mz_comments
WHERE object_type = 'materialized-view'
----


# Test: schema mismatch errors

# missing column in replacement
simple
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT a FROM t
----
db error: ERROR: replacement schema differs from target schema
DETAIL: missing column "b" at position 2

# extra column in replacement
simple
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT a, b, 1 as c FROM t
----
db error: ERROR: replacement schema differs from target schema
DETAIL: extra column "c" at position 3

# name mismatch
simple
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT a AS c, b FROM t
----
db error: ERROR: replacement schema differs from target schema
DETAIL: column at position 1: name mismatch (target: "a", replacement: "c")

# type mismatch
simple
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT a::text, b FROM t
----
db error: ERROR: replacement schema differs from target schema
DETAIL: column "a" at position 1: type mismatch (target: Int32, replacement: String)

# nullability mismatch
simple
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT a, b FROM t WHERE a IS NOT NULL
----
db error: ERROR: replacement schema differs from target schema
DETAIL: column "a" at position 1: nullability mismatch (target: NULL, replacement: NOT NULL)

# key mismatch
simple
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT DISTINCT a, b FROM t
----
db error: ERROR: replacement schema differs from target schema
DETAIL: keys differ (target: (none), replacement: {a, b})

# multiple mismatches
simple
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT DISTINCT a, b AS c, 1 AS d FROM t WHERE a IS NOT NULL
----
db error: ERROR: replacement schema differs from target schema
DETAIL: column "a" at position 1: nullability mismatch (target: NULL, replacement: NOT NULL)
column at position 2: name mismatch (target: "b", replacement: "c")
extra column "d" at position 3
keys differ (target: (none), replacement: {a, c})


statement ok
DROP MATERIALIZED VIEW mv CASCADE;


# Test: attempting to replace constant MVs gives a helpful error

statement ok
CREATE MATERIALIZED VIEW mv AS SELECT 1

statement ok
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT 2

# If we run too quickly the replacement can succeed, so make sure we can select
query I
SELECT * FROM mv
----
1

simple
ALTER MATERIALIZED VIEW mv APPLY REPLACEMENT rp
----
db error: ERROR: materialized view mv is sealed and thus cannot be replaced
DETAIL: The materialized view has already computed its output until the end of time, so replacing its definition would have no effect.

statement ok
DROP MATERIALIZED VIEW mv CASCADE


# Test: MV catalog ID evolves to replacement ID after application

statement ok
CREATE MATERIALIZED VIEW mv AS SELECT a, b FROM t

statement ok
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT a + 1 as a, b FROM t

# Add a dependent MV, so we also test that dependencies are correctly updated.
statement ok
CREATE MATERIALIZED VIEW mv2 AS SELECT * FROM mv;

query TT
SELECT id, name FROM mz_materialized_views
----
u15  mv
u16  rp
u17  mv2

query TT
SELECT d.object_id, d.referenced_object_id
FROM mz_internal.mz_object_dependencies d
JOIN mz_materialized_views m ON m.id = d.referenced_object_id
----
u16  u15
u17  u15

statement ok
ALTER MATERIALIZED VIEW mv APPLY REPLACEMENT rp

query TT
SELECT id, name FROM mz_materialized_views
----
u16  mv
u17  mv2

query TT
SELECT d.object_id, d.referenced_object_id
FROM mz_internal.mz_object_dependencies d
JOIN mz_materialized_views m ON m.id = d.referenced_object_id
----
u17  u16

statement ok
DROP MATERIALIZED VIEW mv CASCADE


# Test: privileges are preserved after replacement

statement ok
CREATE MATERIALIZED VIEW mv AS SELECT a, b FROM t

statement ok
CREATE ROLE test_role

simple conn=mz_system,user=mz_system
GRANT USAGE ON CLUSTER quickstart TO test_role
----
COMPLETE 0

statement ok
GRANT SELECT ON mv TO test_role

simple conn=test_role,user=test_role
SELECT * FROM mv
----
COMPLETE 0

statement ok
CREATE REPLACEMENT MATERIALIZED VIEW rp FOR mv AS SELECT a + 1 AS a, b FROM t

statement ok
ALTER MATERIALIZED VIEW mv APPLY REPLACEMENT rp

simple conn=test_role,user=test_role
SELECT * FROM mv
----
COMPLETE 0
